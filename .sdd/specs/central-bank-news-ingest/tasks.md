# 実装タスクリスト

## セクション1：データモデル実装
- [x] 1.1 必要な型定義・データ構造を作成する
  - Prisma スキーマに `institution`, `person`, `alias`, `article`, `article_person`, `summary`, `ingest_job_run` を定義し、マイグレーションを用意する
  - API/ジョブで利用する TypeScript 型（DTO・レスポンス型・環境変数設定型）とバリデーション（Zod 等）を整備する
- [x] 1.2 データ永続化層を実装する
  - `src/lib/prisma.ts` シングルトン、`PersistenceService`（または Prisma リポジトリ群）を実装して CRUD/トランザクション処理を提供する
  - URL 正規化重複チェック、`ingest_job_run` 集計更新、人物辞書ロードを含む永続化ユーティリティを作成する

## セクション2：ビジネスロジック実装
- [x] 2.1 IngestScheduler / IngestJobRunner のコア処理を実装する
  - Cron トリガ（Railway CLI / 内部 Cron）の共通起動口を整備し、design.md 処理フロー1–3（辞書ロード→RSS 取得→重複排除）に対応する
  - 並列数・タイムアウト・リトライを環境変数から読み込み、構造化ログ出力を実装する
  - ✅ 2025-10-20: 内部 Cron オプトイン・ジョブ超過タイムアウト・リトライ制御・構造化ログを実装済み。次は RssFetcher/ArticleProcessor 連携を拡張する。
- [x] 2.2 RssFetcher・ArticleProcessor・SummaryService を実装する
  - design.md 処理フロー4–5に従い、本文抽出・人物マッチング・OpenAI 要約生成を行う
  - 要約失敗や本文抽出失敗のリトライ／スキップ処理を実装し、再実行時に再試行できるよう状態を管理する
  - ✅ 2025-10-20: Google News RSS フェッチャー・記事処理・要約サービスをモジュール化し、node:test で TDD 完了。要約 API 失敗時の再試行と構造化ログを実装済み。次は 2.3 の詳細エラー分類と監査ログ整備に着手する。
- [x] 2.3 エラーハンドリングを実装する
  - RSS/HTTP 失敗、OpenAI エラー、Prisma トランザクション失敗、認証失敗など design.md に列挙されたケースごとにリカバリ処理を組み込む
  - 構造化ログへエラー種別とスタック情報を出力し、ジョブ統計(`inserted`/`deduped`/`errors`)を更新する
  - ✅ 2025-10-20: IngestError 系例外でコード・スタック・詳細を構造化出力し、リトライ/ジョブ統計テストで検証済み。Summary 空振りや RSS 取得失敗時の再試行・失敗ログも追加。

## セクション3：インターフェース実装
- [x] 3.1 UIコンポーネント/APIエンドポイントを作成する
  - 公開 API (`GET /api/persons`, `GET /api/articles`, `GET /api/articles/[id]`) と管理 API (`/api/admin/persons`) を Route Handler で実装する
  - 公開 UI（一覧・詳細）と管理 UI（人物/エイリアス CRUD、Basic 認証フロー）を App Router セグメントで構築する
  - ✅ 2025-10-21: 4つの Route Handler を追加し、ニュース一覧・詳細、管理ダッシュボードの UI を新規実装。管理 UI では Basic 認証ミドルウェアとサーバーアクションで CRUD を完結。
- [x] 3.2 入力バリデーションを実装する
  - API クエリ/ボディ検証、管理 UI フォーム検証、環境変数ロード時のスキーマバリデーションを追加する
  - ✅ 2025-10-21: Zod スキーマで公開 API クエリ・管理 API ボディを検証し、UI フォームはクリーンアップ後にサーバーアクションへ連携。
- [x] 3.3 出力フォーマットを実装する
  - 要件どおり JST 表示・カーソルベースページネーションを整備し、API レスポンスを要約メタデータ付き JSON として整形する
  - Public UI では Core Web Vitals 対策（Skeleton, Streaming 等）を取り入れる
  - ✅ 2025-10-21: JST フォーマット関数・カーソルエンコードを実装し、NewsList Skeleton + Suspense を導入して LCP 対策。

## セクション4：統合とテスト
- [x] 4.1 コンポーネントを統合する
  - Cron 起動から永続化・API/UI 表示までのデータフローを通し、サーバー/クライアントコンポーネント間の依存を調整する
  - Basic 認証ミドルウェアと IP 制限設定、環境変数ドキュメントを README に追記する
  - ✅ 2025-10-21: `scripts/ingest.ts` で Cron/ジョブ統合と CLI エントリを整備し、middleware に依存注入フックを追加。README に環境変数・Cron 実行手順を反映。
- [x] 4.2 基本的な動作テストを実装する
  - Prisma モデルのテーブル間制約テスト、ジョブロジックのユニット/統合テスト（モック HTTP/AI）、API Route の E2E テストを追加する
  - 内部 Cron のスケジュール切り替えやリトライのユニットテストを整備する
  - ✅ 2025-10-21: API ルート統合テスト・ミドルウェア検証・ingest CLI スタブテストを追加し、既存ユニットテストとあわせて node:test で全工程をカバー。
- [x] 4.3 要件の受入基準を満たすことを確認する
  - 非機能要件(タイムアウト・リトライ・構造化ログ・JST 表示等)をチェックリスト化し、デプロイ手順/バックアップ手順を README に反映する
  - ✅ 2025-10-21: README に Cron/バックアップ手順・環境変数一覧を追加し、JST 表示・Basic 認証/IP 制限・ジョブ統計ログをテストで確認済み。
